<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>seneca-analyze</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.7.0/vis.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.js"></script>

    <script type="application/javascript">
        var getSourceId = function (source) { return '_source_' + source }

        /**
         * Add a node if id doesn't already exist
         */
        var addNode = function(nodes, node) {
            if(_.isUndefined(_.findWhere(nodes, {id : node.id}))) {
                node.label = node.label.replace('\/','\n')
                nodes.push(node)
            }
        }

        var addEdge = function(edges, edge) {
            if(_.isUndefined(_.findWhere(edges, {from: edge.from, to: edge.to}))) {
                edges.push(edge)
            }
        }

        var renderData = function(data) {
            var nodes = []
            var edges = []

            var actorSources = {}
            _.forEach(_.keys(data.actors), function(source) {
                var sourceId = getSourceId(source)
                nodes.push({id: sourceId, label: source, group: sourceId, shape: 'dot', size: 50, borderWidth: 2, font: {size: 30}})

                _.forEach(data.actors[source], function(actor) {
                    actorSources[actor] = sourceId
                    addNode(nodes, {id: actor, label: actor, group: sourceId, shape: 'box'})
                    addEdge(edges, {from: sourceId, to: actor, dashes: true})
                })
            })

            nodes.push({id: 'UNKNOWN', label: 'UNKNOWN'})

            _.forEach(_.keys(data.actions), function(source) {
                var sourceId = getSourceId(source)
                _.forEach(data.actions[source], function(action) {
                    // Undeclared actors get their own style
                    addNode(nodes, {id: action, label: action, group: sourceId, shape: 'box', shapeProperties:{borderDashes:true}, font: {size: 30}, size: 50})
                    addEdge(edges, {from: getSourceId(source), to: action, arrows: 'to'})
                })
            })

            var container = $('#senecaNetwork').get(0)

            var options = {
                autoResize: true,
                height: '100%',
                nodes: {
//                    shape: 'dot',
                    scaling: {
                        min: 10,
                        max: 30,
                        label: {
                            min: 8,
                            max: 30,
                            drawThreshold: 12
//                            maxVisible: 20
                        }
                    }
                },
                interaction:{
                    hover: true,
                    navigationButtons: true
                },
                layout:{
                    randomSeed:2
                }
            }
            var network = new vis.Network(container, {nodes: nodes, edges: edges}, options)
        }

        $(document).ready(function () {
            $.getJSON('/data', function(data) {
                renderData(data)
            })
        })
    </script>

    <style>
        #senecaNetwork {
            width: 1920px;
            height: 1080px;
        }
    </style>
</head>
<body>
<div id="senecaNetwork"></div>
</body>
</html>