<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>seneca-analyze</title>
    <script src="http://d3js.org/d3.v3.js"></script>
    <script src="http://cpettitt.github.io/project/dagre-d3/v0.3.0/dagre-d3.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.js"></script>

    <script type="application/javascript">
        var createIfNeeded = function(graph, label, id, group, parent) {
            if(_.isUndefined(graph.node(id))) {
                console.log("NODE", id, label, group)
                graph.setNode(id, {label: label, group: group})
                if(parent) {
                    console.log('PARENT', id, parent)
                    graph.setParent(id, parent)
                }
            }
        }
        var renderData = function(data) {
            var g = new dagreD3.graphlib.Graph({compound: true})
            g.setGraph({})
            g.setDefaultEdgeLabel(function() { return {} })

            g.setNode("group", {label: 'Group', group: 'group'})

            _.forEach(_.keys(data.actors), function(source) {
                createIfNeeded(g, source, source + '_group', source, 'group')
                _.forEach(data.actors[source], function(actor) {
                    createIfNeeded(g, actor, actor, source, source+'_group')
                })
            })


            createIfNeeded(g, 'UNKNOWN', 'UNKNOWN', 'UNKNOWN', 'group')

            _.forEach(_.keys(data.actions), function(source) {
                _.forEach(data.actions[source], function(action) {
                    var groupNodeId = source + '_group'
                    createIfNeeded(g, source, groupNodeId, source, 'group')
                    if(_.isUndefined(g.node(action))) {
                        createIfNeeded(g, action, action, 'UNKNOWN', 'UNKNOWN')
                    }
                    g.setEdge(groupNodeId, action)
                    console.log('EDGE', groupNodeId, action)
                })
            })

            var render = new dagreD3.render();

            // Set up an SVG group so that we can translate the final graph.
            var svg = d3.select("svg"),
            svgGroup = svg.append("g");

            render(d3.select("svg g"), g);

            // Center the graph
            var xCenterOffset = (svg.attr("width") - g.graph().width) / 2;
            svgGroup.attr("transform", "translate(" + xCenterOffset + ", 20)");
            svg.attr("height", g.graph().height + 40);
        }

        $(document).ready(function () {
            $.getJSON('/data', function(data) {
                renderData(data)
            })
        })
    </script>

    <style>
        .clusters rect {
            fill: #00ffd0;
            stroke: #999;
            stroke-width: 1.5px;
        }

        text {
            font-weight: 300;
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 14px;
        }

        .node rect {
            stroke: #999;
            fill: #fff;
            stroke-width: 1.5px;
        }

        .edgePath path {
            stroke: #333;
            stroke-width: 1.5px;
        }
    </style>
</head>
<body>
<svg id="svg-canvas" width=960 height=600></svg>
</body>
</html>