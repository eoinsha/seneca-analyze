<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>seneca-analyze</title>
    <script src="http://d3js.org/d3.v3.js"></script>
    <script src="http://cpettitt.github.io/project/dagre-d3/v0.3.0/dagre-d3.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.js"></script>

    <script type="application/javascript">
        var renderData = function(data) {
            var g = new dagreD3.graphlib.Graph({compound: true})
            g.setGraph({})
            g.setDefaultEdgeLabel(function() { return {} })

            var actorSources = {}
            _.forEach(_.keys(data.actors), function(source) {
                g.setNode(source, { label: source, group: source })

                _.forEach(data.actors[source], function(actor) {
                    actorSources[actor] = source
                })
            })

            g.setNode('UNKNOWN', {label: 'UNKNOWN'})

            _.forEach(_.keys(data.actions), function(source) {
                _.forEach(data.actions[source], function(action) {
                    if(!g.hasNode(source)) g.setNode(source, {label: source, group: source})
                    var dest = actorSources[action] || 'UNKNOWN'
                    g.setEdge(source, dest, {label: action, lineInterpolate: 'basis'})
                })
            })

            var render = new dagreD3.render();

            // Set up an SVG group so that we can translate the final graph.
            var svg = d3.select("svg"),
            svgGroup = svg.append("g");
            var zoom = d3.behavior.zoom().on("zoom", function() {
                svgGroup.attr("transform", "translate(" + d3.event.translate + ")" +
                    "scale(" + d3.event.scale + ")");
            });
            svg.call(zoom);


            render(svgGroup, g);


            // Center the graph
            var initialScale = 0.75;
            zoom.translate([(svg.attr("width") - g.graph().width * initialScale) / 2, 20])
                .scale(initialScale)
                .event(svg);
            svg.attr('height', g.graph().height * initialScale + 40);
        }

        $(document).ready(function () {
            $.getJSON('/data', function(data) {
                renderData(data)
            })
        })
    </script>

    <style>
        .clusters rect {
            fill: #00ffd0;
            stroke: #999;
            stroke-width: 1.5px;
        }

        text {
            font-weight: 300;
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 14px;
        }

        .node rect {
            stroke: #999;
            fill: #fff;
            stroke-width: 1.5px;
        }

        .edgePath path {
            stroke: #333;
            stroke-width: 1.5px;
        }
    </style>
</head>
<body>
<svg id="svg-canvas" width=1920 height=1080></svg>
</body>
</html>