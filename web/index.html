<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>seneca-analyze</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.7.0/vis.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.js"></script>
    <script src="colorTag.js"></script>
    <script src="readableForeground.js"></script>

    <script type="application/javascript">
        var network
        var actorSources = {}
        var sources = []
        var sourceColours = {}
        var getSourceId = function (source) { return '_source_' + source }

        /**
         * Add a node if id doesn't already exist
         */
        var addNode = function(nodes, node) {
            if(_.isUndefined(_.findWhere(nodes, {id : node.id}))) {
                var colour = colorTag(node.group)
                node.color = '#' + colour.hex()
                if(!_.includes(['dot'], node.shape)) {
                    node.font = {color: '#' + readableForeground(colour.hex())}
                }
                node.label = node.label.replace('\/','\n')
                nodes.push(node)
            }
        }

        var addEdge = function(nodes, edges, edge) {
            var srcNode = _.findWhere(nodes, {id: edge.from})
            if(!_.isUndefined(srcNode)) {
                srcNode.value++
            }
            var destNode = _.findWhere(nodes, {id : edge.to})
            if(!_.isUndefined(destNode)) {
                destNode.value++
            }
            if(_.isUndefined(_.findWhere(edges, {from: edge.from, to: edge.to}))) {
                edges.push(edge)
            }
        }

        var renderData = function(data) {
            var nodes = []
            var edges = []

            _.forEach(_.keys(data.actors), function(source) {
                var sourceId = getSourceId(source)
                sources.push(source)
                addNode(nodes, {id: sourceId, label: source, value: 2, group: sourceId, shape: 'dot', borderWidth: 2})

                _.forEach(data.actors[source], function(actor) {
                    actorSources[actor] = sourceId
                    addNode(nodes, {id: actor, label: actor, value: 0, group: sourceId, shape: 'box'})
                    addEdge(nodes, edges, {from: sourceId, to: actor, dashes: true})
                })
            })

            _.forEach(_.keys(data.actions), function(source) {
                var sourceId = getSourceId(source)
                _.forEach(data.actions[source], function(action) {
                    // Undeclared actors get their own style
                    addNode(nodes, {id: action, label: action, value: 1, group: sourceId, shape: 'box', shapeProperties:{borderDashes:true}})
                    addEdge(nodes, edges, {from: getSourceId(source), to: action, arrows: 'to'})
                })
            })

            var container = $('#senecaNetwork').get(0)

            var options = {
                autoResize: true,
                height: '100%',
                nodes: {
//                    shape: 'dot',
                    scaling: {
                        min: 10,
                        max: 30,
                        label: {
                            min: 8,
                            max: 30,
                            drawThreshold: 12
//                            maxVisible: 20
                        }
                    }
                },
                interaction:{
                    hover: true,
                    navigationButtons: true
                },
                layout:{
                    randomSeed:2
                },
                physics: {
                    stabilization: {
                        enabled: true,
                        iterations: 180, // maximum number of iteration to stabilize
                        updateInterval: 10,
                        onlyDynamicEdges: false,
                        fit: true
                    }
                }
            }
            network = new vis.Network(container, {nodes: nodes, edges: edges}, options)
            network.on("doubleClick", function(params) {
                if (params.nodes.length == 1) {
                    if (network.isCluster(params.nodes[0]) == true) {
                        network.openCluster(params.nodes[0]);
                    }
                    else {
                        clusterBySource(params.nodes[0])
                    }
                }
            })
        }

        var clusterBySource = function(sourceId) {
            var sourceNode = network.findNode(sourceId)[0]
            clusterOptionsByData = {
                joinCondition: function (childOptions) {
                    return childOptions.group === sourceId; // the color is fully defined in the node.
                },
                processProperties: function (clusterOptions, childNodes, childEdges) {
                    var totalMass = 0;
                    for (var i = 0; i < childNodes.length; i++) {
                        totalMass += childNodes[i].mass;
                    }
                    clusterOptions.mass = totalMass;
                    return clusterOptions;
                },
                clusterNodeProperties: {id: 'cluster:' + sourceId, borderWidth: 3, shape: 'square', label:sourceNode.options.label,
                    color: sourceNode.options.color, font: {color: sourceNode.options.font.color}}
            }
            network.cluster(clusterOptionsByData);
        }

        var clusterAllSources = function() {
            _.forEach(sources, function(source) {
                clusterBySource(getSourceId(source))
            })
        }

        var declusterAllSources = function() {
            _.forEach(sources, function(source) {
                network.openCluster('cluster:' + getSourceId(source))
            })
        }

        $(document).ready(function () {
            $.getJSON('/data', function(data) {
                renderData(data)
            })
        })
    </script>

    <style>
        #senecaNetwork {
            width: 1600px;
            height: 900px;
        }
    </style>
</head>
<body>
<div>
<span><input type="button" onclick="clusterAllSources()" value="Collapse All"></span>
<span><input type="button" onclick="declusterAllSources()" value="Expand All"></span>
</div>
<div id="senecaNetwork"></div>
</body>
</html>